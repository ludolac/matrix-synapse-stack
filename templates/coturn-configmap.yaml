{{- if .Values.coturn.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "matrix-synapse.fullname" . }}-coturn-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "matrix-synapse.labels" . | nindent 4 }}
    app.kubernetes.io/component: coturn
data:
  turnserver.conf: |
    # Coturn TURN Server Configuration
    # Generated by Matrix Synapse Helm Chart

    # Listener IP address
    listening-ip=0.0.0.0

    # Relay IP address (external IP for NAT)
    {{- if .Values.coturn.externalIP }}
    external-ip={{ .Values.coturn.externalIP }}
    {{- end }}

    # TURN server ports
    listening-port=3478
    tls-listening-port=5349

    # Relay ports range for media
    min-port={{ .Values.coturn.relayPortRange.min }}
    max-port={{ .Values.coturn.relayPortRange.max }}

    # Realm for TURN server
    realm={{ .Values.coturn.realm }}

    # Authentication - use shared secret (passed via command line argument)
    use-auth-secret
    # Note: static-auth-secret is passed via command line to support environment variable expansion

    # Security: Disable insecure protocols
    no-tlsv1
    no-tlsv1_1

    {{- if .Values.coturn.tls.enabled }}
    # TLS certificates
    cert=/etc/coturn/certs/tls.crt
    pkey=/etc/coturn/certs/tls.key
    {{- end }}

    # Security: Fingerprint for WebRTC
    fingerprint

    # Security: Prevent loopback and private IP relay
    no-multicast-peers
    denied-peer-ip=0.0.0.0-0.255.255.255
    denied-peer-ip=10.0.0.0-10.255.255.255
    denied-peer-ip=100.64.0.0-100.127.255.255
    denied-peer-ip=127.0.0.0-127.255.255.255
    denied-peer-ip=169.254.0.0-169.254.255.255
    denied-peer-ip=172.16.0.0-172.31.255.255
    denied-peer-ip=192.0.0.0-192.0.0.255
    denied-peer-ip=192.0.2.0-192.0.2.255
    denied-peer-ip=192.88.99.0-192.88.99.255
    denied-peer-ip=192.168.0.0-192.168.255.255
    denied-peer-ip=198.18.0.0-198.19.255.255
    denied-peer-ip=198.51.100.0-198.51.100.255
    denied-peer-ip=203.0.113.0-203.0.113.255
    denied-peer-ip=240.0.0.0-255.255.255.255
    denied-peer-ip=::1
    denied-peer-ip=64:ff9b::-64:ff9b::ffff:ffff:ffff:ffff
    denied-peer-ip=::ffff:0.0.0.0-::ffff:255.255.255.255
    denied-peer-ip=100::-100::ffff:ffff:ffff:ffff
    denied-peer-ip=2001::-2001:1ff:ffff:ffff:ffff:ffff:ffff:ffff
    denied-peer-ip=2002::-2002:ffff:ffff:ffff:ffff:ffff:ffff:ffff
    denied-peer-ip=fc00::-fdff:ffff:ffff:ffff:ffff:ffff:ffff:ffff
    denied-peer-ip=fe80::-febf:ffff:ffff:ffff:ffff:ffff:ffff:ffff

    # Performance and reliability
    verbose
    log-file=stdout

    # User quota to prevent abuse
    user-quota={{ .Values.coturn.userQuota }}
    total-quota={{ .Values.coturn.totalQuota }}

    # Bandwidth limits
    max-bps={{ .Values.coturn.maxBps }}
    bps-capacity={{ .Values.coturn.bpsCapacity }}

    # Session lifetime
    stale-nonce=600

    # Security: Disable CLI
    no-cli

    # Note: User/group privileges are managed by Kubernetes securityContext in the deployment
    # The container already runs as UID/GID 65534 (nobody:nogroup)

    {{- if .Values.coturn.prometheusExporter.enabled }}
    # Prometheus metrics
    prometheus
    {{- end }}

    {{- with .Values.coturn.extraConfig }}
    # Extra configuration
    {{- . | nindent 4 }}
    {{- end }}
{{- end }}
